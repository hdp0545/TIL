# KAFKA

### what is kafka

- pub-sub 모델의 Message Queue
- 대용량의 실시간 로그 처리에 특화된 메시징 시스템
- 단순한 메시지 헤더를 지닌 TCP 기반의 프로토톨 사용
- 메시지를 파일 시스템에 저장하기 때문에 성능 유리

### compare with RabbitMQ

| 항목        | RabbitMQ                            | kafka                                                        |
| ----------- | ----------------------------------- | ------------------------------------------------------------ |
| xmrwld      | - 전통적인 접근방식의 메시지 브로커 | - 대용량 실시간 로그처리<br />분산 아키텍처 기반의 대량 데이터 처리 |
|             | 발송확인 O                          | 발송 확인 O                                                  |
|             | 수신확인 O                          | 수신 확인 X                                                  |
| 저장공간    | 메모리                              | 디스크                                                       |
| 기반        | queue기반                           | Log기반                                                      |
| 메시지 보관 | 수신 즉시 삭제                      | 상시보관                                                     |
|             |                                     |                                                              |

수평적 확장이 용이

zookeeper가 메시지 관리를 함..



### Brokers

- 여러개의 브로커가 모여 클러스터를 이룸
- 브로커당 토픽이 있고 이는 한개 이상의 파티션으로 구성되어 있음.(파티션 저장 공간)
- 브로커당 파티션은 4000개 정도 가지고 있음.
- 같은 메시지를 다른 파티션에 복제하여 안정성을 추구함.

##### replication

- 리드 브로커가 꺼지면 나머지 팔로워가 리더의 역할을 수행함으로써 Service Always구현



### 카프카의 확장성

- 두 개 이상의 Node에 브로커를 골고루 분배하여야 함.
- 서버(node)가 죽을 때 같은 토픽당 브로커가 하나는 살아있게 하기 위함.



### retention period and compaction

- 삭제정책은 시간 및 용량으로 관리 가능하다..



### key

- 메세지의 순서가 보장되기 위해서는 특정한 파티션에 데이터를 저장하여야 한다.
- 프로듀서가 key를 입력하는 방식으로 메세지를 저장할 특정 파티션을 지정 할 수 있다.
- value만 주어질 경우 모든 파티션에 골고루 메세지들이 저장되게 된다.



### Producer option

##### 저장레벨

- 0
  - fire and forget
  - 리스크가 크고 데이터 유실 가능성이 있으나 제일 빠름
- 1
  - 데이터 유실가능성이 적고
- all
  - 자원소모가 크나 데이터 유실 가능성이 없음

##### 재시도 횟수

- 실패시 횟수 지정 가능



### Consumer Option

- ##### 커밋 옵션

- automatic

  - 일정한 간격으로 커밋(5s)

- Manual(비동기)

  - 상당히 안전하고

- synchronous(동기)

  - 제일 안정적
  - 순차적으로 커밋을 진행함.



### consumer group

- 그룹별로 거래를 진행하고 그 그룹당 동일메세지를 전송가능함.



### Kafka Json

- 장점
  - json은 제일 많이 사용되는 방식
  - 유용함
- 단점
  - 데이터 스키마 지정을 통해 규정하거나 제한이 불가능하다.